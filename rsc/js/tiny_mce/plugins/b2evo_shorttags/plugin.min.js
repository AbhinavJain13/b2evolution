tinymce.PluginManager.add("b2evo_shorttags",function(a){function b(a,b,c){function d(a,b){return b=b||[],tinymce.each(a,function(a){c&&c!=a.type||(menuItem={text:a.title||a.name,value:a.link_ID},b.push(menuItem))}),b}return d(a,[])}function c(c){var d=null;q&&(d=n(q)),c&&(imageListCtrl={type:"listbox",name:"link",label:"Attached images",values:b(c,function(b){b.value=a.convertURL(b.value||b.url,"src")},"image"),value:d?d.linkId:null}),p=a.windowManager.open({title:"Insert/Edit Image",body:[imageListCtrl,{type:"container",label:"Caption:",layout:"flex",direction:"row",align:"center",spacing:5,items:[{type:"textbox",name:"caption",value:d&&"-"!=d.caption?d.caption:null},{type:"checkbox",name:"nocaption",text:"Do not show caption",checked:d&&"-"==d.caption,onclick:function(){var a=p.find("#caption")[0];a.disabled(this.checked())}}]},{type:"listbox",name:"alignment",label:"Alignment:",values:[{text:"none",value:""},{text:"left",value:".floatleft"},{text:"right",value:".floatright"}],value:d?d.alignment:""},{type:"textbox",name:"imageClass",label:"Additional class:",value:d?d.extraClass:null}],buttons:[{text:"Cancel",onclick:"close"},{text:q?"Update":"Insert",onclick:function(){var b=p.find("#link")[0],c=p.find("#caption")[0],d=p.find("#nocaption")[0],e=p.find("#alignment")[0],f=p.find("#imageClass")[0],i="[image:"+b.value();if((d.checked()||c.value()||e.value())&&(i+=":",d.checked()?i+="-":c.value()&&(i+=c.value()),e.value()||f.value())){var j=e.value();i+=":"+j+f.value()}i+="]";var k=h(i);k===!1?g([i],function(b){for(var c=0;c<r.length;c++)if(r[c].shortTag==i){k=r[c];break}k&&(q?a.dom.replace(k.node,q,!1):a.insertContent(k.html),a.windowManager.close())}):(q?a.dom.replace(k.node,q,!1):a.insertContent(k.html),a.windowManager.close())}}]})}function d(a){return a.stopPropagation(),!1}function e(b){var c=a.dom;b!==q&&(a.getBody().focus(),f(),q=b,jQuery(q).bind("paste cut",d),c.bind(q,"beforedeactivate focusin focusout",d))}function f(){jQuery(q).off("paste cut beforedeactive focusin focusout"),q=null}function g(b,c){for(var d=[],e=0;e<b.length;e++){var f=h(b[e]);f===!1&&(r.push({shortTag:b[e],html:null,node:null,type:null,rendered:!1}),d.push("tags[]="+encodeURI(b[e])))}d.length?(d=d.join("&"),tinymce.util.XHR.send({url:a.getParam("async_url")+"?action=render_inlines&p="+a.getParam("postID"),content_type:"application/x-www-form-urlencoded",data:d,success:function(b){var d=tinymce.util.JSON.parse(b);for(tag in d){var e=a.dom.create("div"),f=a.dom.createFragment(d[tag]),g=o(tag);a.dom.setAttrib(f.childNodes[0],"data-b2evo-tag",window.encodeURIComponent(tag)),a.dom.setAttrib(f.childNodes[0],"data-b2evo-type",g.type),a.dom.addClass(f.childNodes[0],"b2evo-tag"),e.appendChild(f);var i=h(tag);i===!1?r.push({shortTag:tag,html:e.innerHTML,node:e.childNodes[0],type:tagdata.type,rendered:!0}):i.rendered===!1&&(i.html=e.innerHTML,i.node=e.childNodes[0],i.rendered=!0)}c(d)}})):c()}function h(a){for(var b=r.length,c=0;b>c;c++)if(r[c].shortTag==a)return r[c];return!1}function i(a){for(var b,c=/(<span.*?data-b2evo-tag.*?>)?(\[(image|video|audio):(\d+):?([^\[\]]*)\])(<\/span>)?/gi,d=[],e=[];null!==(b=c.exec(a));)b.index===c.lastIndex&&c.lastIndex++,d.push({shortTag:b[2],inlineType:b[3],linkId:parseInt(b[4]),other:b[5],openTag:b[1],closeTag:b[6]}),e.push(b[2]);g(e,function(a){a&&k()});for(var f=d.length,i=0;f>i;i++)if(d[i]&&!d[i].openTag&&!d[i].closeTag){var j=d[i].shortTag,l=h(j);if(l!==!1&&l.rendered!==!1)switch(d[i].inlineType){case"image":a=a.replace(j,l.html);break;default:a=a.replace(j,'<span style="color: green;" data-b2evo-tag>'+j+"</span>")}}return a}function j(b){b=b.replace(/(<span [^>]+data-b2evo-error[^>]+>(.*?)<\/span>)/gi,function(a,b,c){return c});for(var c=/(<span.*?data-b2evo-tag.*?>)?(\[(image|file|inline|video|audio|thumbnail):(\d+):?([^\[\]]*)\])(<\/span>)?/gi;null!==(m=c.exec(b));)m.index===c.lastIndex&&c.lastIndex++,m[1]&&m[6]&&(b=b.replace(m[0],m[2]));for(var d,e=a.dom.createFragment(b);d=e.querySelector("[data-b2evo-tag]");){var f=window.decodeURIComponent(d.getAttributeNode("data-b2evo-tag").value);d.parentNode.replaceChild(document.createTextNode(f),d)}var g=a.dom.create("div");return g.appendChild(e),g.innerHTML}function k(){var b=a.getContent();a.setContent(i(b))}function l(a,b){for(b||(b="data-b2evo-tag");a.parentNode;){if("#text"!=a.nodeName&&a.getAttribute(b))return a;a=a.parentNode}return!1}function n(a){var b=a.getAttribute("data-b2evo-tag");return b?o(b):!1}function o(a){if(a){a=window.decodeURIComponent(a);var b=/\[(image|file|inline|video|audio|thumbnail):(\d+):?([^\[\]]*)\]/i,c=b.exec(a),d={tag:c[0],type:c[1],linkId:parseInt(c[2])};switch(d.type){case"image":var e=c[3];if(e){if(e=e.split(":"),e[0]&&(d.caption=e[0]),e[1]){for(var f,g=e[1],h=[".floatleft",".floatright"],i=-1,j=0;j<h.length;j++)f=g.indexOf(h[j]),f>i&&(i=f,d.alignment=h[j]);var k=g.split(".");d.extraClass="";for(var j=0;j<k.length;j++)""!=k[j]&&-1===h.indexOf("."+k[j])&&(d.extraClass+="."+k[j])}}else d.caption=null,d.extraClass=null;break;default:d.options=c[3]}return d}return!1}var p,q,r=[],s=this;s.selected=function(){return q},a.addButton("b2evo_image",{text:"[image:]",icon:!1,tooltip:"Insert Image",onclick:function(){if(a.getParam("postID")){for(var b=a.getParam("attachments"),d=[],e=0;e<b.length;e++)"image"==b[e].type&&"inline"==b[e].position&&d.push(b[e]);jQuery.isEmptyObject(d)?alert("You must have at least one attached image in the Inline position."):c(d)}else alert("You must save the post (at least as a draft) before you can attach images.")},onPostRender:function(){var b=this;a.on("NodeChange",function(a){if(q){var c=n(q);b.active("image"==c.type)}else b.active(!1)})}}),a.on("BeforeSetContent",function(a){a.content=i(a.content)}),a.on("PostProcess",function(a){a.get&&(a.content=j(a.content))}),a.on("attachmentsLoaded",function(a){k()}),a.on("mousedown mouseup click",function(a){var b=l(a.target);b?e(b):f()},!0),a.on("keypress keydown keyup",function(b){if(q){var c=[];if(c.push(16,17,18,19),c.push(20,27,45),c.push(33,34,35,36),c.push(37,38,39,40),c.push(91,92,93),c.push(112,113,114,115,116,117,118,119,120,121,122,123),c.push(144,145),8==b.which||46==b.which)a.dom.remove(q);else if(-1==c.indexOf(b.which))return b.preventDefault(),!1}},!0),a.on("NodeChange",function(b){if(b.selectionChange){var c=l(a.selection.getNode());c?e(c):f()}}),a.on("ResolveName",function(b){if(a.dom.hasClass(b.target,"b2evo-tag")){var c=a.dom.getAttrib(b.target,"data-b2evo-type");c?b.name="["+c+":]":b.name="shorttag",b.stopPropagation()}else l(b.target)&&(b.preventDefault(),b.stopPropagation())}),a.on("dragstart",function(a){var b=l(a.target);if(b){e(b);var c=window.decodeURIComponent(b.getAttribute("data-b2evo-tag"));a.dataTransfer.setData("application/x-moz-node",a.target),a.dataTransfer.setData("text/plain",c),a.dataTransfer.effectAllowed="move"}else f()}),a.on("drop",function(b){var c=b.target,d=b.dataTransfer.getData("text/plain"),e=l(c);return e&&(c=e),"BODY"==c.tagName?(b.preventDefault(),!1):e&&d&&q?(b.preventDefault(),c.insertAdjacentHTML("beforebegin",d),a.dom.remove(q),k(),!1):void 0}),a.on("init",function(){var b=a.selection;a.on("BeforeSetContent",function(){var c,d,e=l(b.getNode());e&&(!e.nextSibling||l(e.nextSibling)?(d=a.getDoc().createTextNode(""),a.dom.insertAfter(d,e)):(c=new tinymce.dom.TreeWalker(e.nextSibling,e.nextSibling),d=c.next()),b.select(d),b.collapse(!0))})})});