tinymce.PluginManager.add( 'b2evo_attachments', function( editor ) {

	// This plugin requires the postID parameter
	if( typeof editor.settings.postID === 'undefined' )
	{
		return;
	}

	if( typeof editor.settings.attachments === 'undefined' )
	{
		editor.settings.attachments = [];
	}

	function getAttachment( linkId )
	{
		var attachments = editor.getParam( 'attachments' );
		for( var i = 0; i < attachments.length; i++ )
		{
			if( attachments[i].link_id == linkId )
			{
				return attachments[i];
			}
		}

		return null;
	}

	function loadAttachments()
	{
		var collection = editor.getParam( 'collection' );
		var postID = editor.getParam( 'postID' );
		var restUrl = editor.getParam( 'rest_url' );

		tinymce.util.XHR.send({
			url: restUrl + '?api_version=1&api_request=collections/' + collection + '/items/' + postID,
			success: function( text ) {
				var attachmentList = tinymce.util.JSON.parse( text ).attachments;
				editor.settings.attachments = [];
				tinymce.each( attachmentList, function( link) {
					editor.settings.attachments.push(link);
				} );
				editor.fire( 'attachmentsLoaded' );
			}
		});
	}

	document.addEventListener( 'b2evoAttachmentsChanged', function( event ) {
		loadAttachments();
	} );

	loadAttachments();
} );