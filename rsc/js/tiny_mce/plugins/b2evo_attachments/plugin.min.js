tinymce.PluginManager.add( 'b2evo_attachments', function( editor ) {
	console.log( editor.settings );
	// This plugin requires the postID parameter
	if( typeof editor.settings.postID === 'undefined' )
	{
		return;
	}

	if( typeof editor.settings.attachments === 'undefined' )
	{
		editor.settings.attachments = {};
	}

	function getAttachment( linkId )
	{
		return editor.getParam( 'attachments' )[linkId];
	}

	function loadAttachments()
	{
		var collection = editor.getParam( 'collection' );
		var postID = editor.getParam( 'postID' );

		tinymce.util.XHR.send({
			//url: 'http://b2evolution.lan/htsrv/rest.php?api_version=1&api_request=items/' + postID + '/attachments',
			url: 'http://b2evolution.lan/htsrv/rest.php?api_version=1&api_request=collections/' + collection + '/items/' + postID,
			success: function( text ) {
				var attachmentList = tinymce.util.JSON.parse( text ).attachments;
				editor.settings.attachments = {};
				tinymce.each( attachmentList, function( link) {
					editor.settings.attachments = {};
					editor.settings.attachments[link.link_ID] = link;
				} );
				editor.fire( 'attachmentsLoaded' );
			}
		});
	}

	document.addEventListener( 'b2evoAttachmentsChanged', function( event ) {
		loadAttachments();
		console.log( 'Here Here');
	} );

	loadAttachments();
} );